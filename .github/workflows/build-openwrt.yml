#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
#
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#
name: ç¼–è¯‘OpenWrtå›ºä»¶
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSHè¿œç¨‹"
        required: false
        default: "ssh-actions"

  #å®šæ—¶è§¦å‘å¼€å§‹ç¼–è¯‘(æŠŠä¸‹é¢ä¸¤ä¸ª#å»æ‰å¼€å¯,æ—¶é—´è®¾ç½®è¯·çœ‹å®šæ—¶ç¼–è¯‘è¯´æ˜)
  schedule:
    - cron: 0 18 * * SAT

env:
  LEDE: https://github.com/coolsnowwolf/lede
  LIENOL: https://github.com/Lienol/openwrt
  PROJECT: https://github.com/immortalwrt/immortalwrt
  GITURL: https://github.com/${{github.repository}}
  Author: ${{github.actor}}
  Run_number: ${{github.run_number}}
  Run_workflow: ${{github.workflow}}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ "${{matrix.target}}"
    strategy:
      fail-fast: false
      matrix:
        target: [Lede_x86_64]

    steps:
      - name: å‡†å¤‡ç»“æŸ
        uses: actions/checkout@v2

      - name: æ£€æµ‹è„šæœ¬è®¾ç½®
        run: |
          source "${GITHUB_WORKSPACE}/build/${{matrix.target}}/settings.ini"
          echo "Modelfile=${{matrix.target}}" >> $GITHUB_ENV
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
          echo "DIY_P1_SH=${DIY_P1_SH}" >> $GITHUB_ENV
          echo "DIY_P2_SH=${DIY_P2_SH}" >> $GITHUB_ENV
          echo "SSH_ACTIONS=${SSH_ACTIONS}" >> $GITHUB_ENV
          echo "UPLOAD_BIN_DIR=${UPLOAD_BIN_DIR}" >> $GITHUB_ENV
          echo "UPLOAD_CONFIG=${UPLOAD_CONFIG}" >> $GITHUB_ENV
          echo "UPLOAD_FIRMWARE=${UPLOAD_FIRMWARE}" >> $GITHUB_ENV
          echo "UPLOAD_COWTRANSFER=${UPLOAD_COWTRANSFER}" >> $GITHUB_ENV
          echo "UPLOAD_RELEASE=${UPLOAD_RELEASE}" >> $GITHUB_ENV
          echo "SERVERCHAN_SCKEY=${SERVERCHAN_SCKEY}" >> $GITHUB_ENV
          echo "REGULAR_UPDATE=${REGULAR_UPDATE}" >> $GITHUB_ENV
          echo "Updete_firmware=${Updete_firmware}" >> $GITHUB_ENV
          echo "Extension=${Extension}" >> $GITHUB_ENV
          echo "GITHUB_RELEASE=$(grep "https://github.com/[a-zA-Z0-9]" ${GITHUB_WORKSPACE}/.git/config | cut -c8-100)" >> $GITHUB_ENV

      - name: å¾®ä¿¡é€šçŸ¥
        uses: emon100/Action-Serverchan@v2
        if: env.SERVERCHAN_SCKEY == 'true'
        with:
          SCKEY: ${{ secrets.SCKEY }}
          text: ä¸»äºº${{matrix.target}}ç¼–è¯‘å¼€å§‹å•¦
          desp: ä¸»äººæ‚¨è¦ç¼–è¯‘çš„[${{matrix.target}}]å›ºä»¶æ­£åœ¨åŠªåŠ›è€•è€˜ä¸­,è¯·è€å¿ƒç­‰å¾…......

      - name: ç”µæŠ¥æœºå™¨äººä¿¡æ¯é€šçŸ¥
        run: |
          curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=ğŸ‰ ä¸»äººæ‚¨è¦ç¼–è¯‘çš„[${{ env.WXFB_MESSAGE }}]å›ºä»¶æ­£åœ¨åŠªåŠ›è€•è€˜ä¸­,è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"

      - name: æ•´ç†ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /usr/lib/jvm /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ä¸‹è½½"${{matrix.target}}"æºç 
        working-directory: /workdir
        run: |
          git clone -b "$REPO_BRANCH" --single-branch "$REPO_URL" "openwrt"
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "Home=${GITHUB_WORKSPACE}/openwrt" >> $GITHUB_ENV
          echo "PATH1=${GITHUB_WORKSPACE}/openwrt/build/${{matrix.target}}" >> $GITHUB_ENV
          echo "artifact=${GITHUB_WORKSPACE}/openwrt/bin/Firmware" >> $GITHUB_ENV

      - name: æ•´ç†è„šæœ¬æ–‡ä»¶
        run: |
          cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
          cp -Rf "${GITHUB_WORKSPACE}/build/common"/*.sh "${PATH1}"
          chmod -R +x "${PATH1}"
          source "${PATH1}/common.sh" && Diy_settings
          rm -rf {build,README.md}
          if [[ "${{ github.event.inputs.ssh }}" == 'ssh' ]]; then
            echo "SSHYC=true" >> $GITHUB_ENV
          fi

      - name: åŠ è½½æº,patchè¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
        run: |
          cd openwrt
          source "${PATH1}/common.sh" && Diy_all
          if [[ "${REPO_URL}" == "${LEDE}" ]]; then
            source "${PATH1}/common.sh" && Diy_lede
          elif [[ "${REPO_URL}" == "${LIENOL}" ]]; then
            source "${PATH1}/common.sh" && Diy_lienol
          elif [[ "${REPO_URL}" == "${PROJECT}" ]]; then
            source "${PATH1}/common.sh" && Diy_immortalwrt
          fi
          /bin/bash "${PATH1}/$DIY_P1_SH"
          ./scripts/feeds clean
          ./scripts/feeds update -a && ./scripts/feeds install -a
          if [[ "${REPO_URL}" == "${LEDE}" ]]; then
            source "${PATH1}/common.sh" && Diy_lede2
            echo "NAME2=Lede" >> $GITHUB_ENV
            echo "ZUOZHE=Lean's" >> $GITHUB_ENV
          elif [[ "${REPO_URL}" == "${LIENOL}" ]]; then
            source "${PATH1}/common.sh" && Diy_lienol2
            echo "NAME2=Lienol" >> $GITHUB_ENV
            echo "ZUOZHE=lienol's" >> $GITHUB_ENV
          elif [[ "${REPO_URL}" == "${PROJECT}" ]]; then
            source "${PATH1}/common.sh" && Diy_immortalwrt2
            echo "NAME2=Project" >> $GITHUB_ENV
            echo "ZUOZHE=ctcgfw" >> $GITHUB_ENV
          fi
          source "${PATH1}/common.sh" && Diy_all2
          if [ -n "$(ls -A "${PATH1}/files" 2>/dev/null)" ]; then
            cp -Rf "${PATH1}/files" "${Home}" && chmod -R +x ${Home}/files
          fi
          if [ -n "$(ls -A "${PATH1}/diy" 2>/dev/null)" ]; then
            cp -Rf "${PATH1}"/diy/* "${Home}"
          fi
          if [ -n "$(ls -A "${PATH1}/patches" 2>/dev/null)" ]; then
            find "${PATH1}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p1 --forward --no-backup-if-mismatch"
          fi
          /bin/bash "${PATH1}/$DIY_P2_SH"
          ./scripts/feeds install -a
          [ -e "$PATH1/$CONFIG_FILE" ] && mv "$PATH1/$CONFIG_FILE" .config
          if [[ "${REGULAR_UPDATE}" == "true" ]]; then
            echo "Compile_Date=$(date +%Y%m%d%H%M)" > $GITHUB_WORKSPACE/Openwrt.info
            source "${PATH1}/upgrade.sh" && Diy_Part1
          fi

      - name: SSHè¿œç¨‹è¿æ¥
        uses: P3TERX/ssh2actions@v1.0.0
        if: env.SSH_ACTIONS == 'true' || (github.event.inputs.ssh == 'ssh' && github.event.inputs.ssh  != 'false')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      # - name: å‡†å¤‡å°±ç»ª
      #   run: |
      #     cd openwrt
      #     source "${PATH1}/common.sh" && Diy_chajian
      #     make defconfig
      #     source "${PATH1}/common.sh" && Diy_adgu
      #     if [ "${REGULAR_UPDATE}" == "true" ]; then
      #       source "${PATH1}/upgrade.sh" && Diy_Part2
      #     fi

      - name: ç¼–è¯‘ä¿¡æ¯
        run: |
          cd openwrt
          source "${PATH1}/upgrade.sh"
          source "${PATH1}/common.sh" && Diy_xinxi

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          make -j$(($(nproc)+1)) || make -j1 V=s
          echo "::set-output name=status::success"
          echo "date=$(date "+%y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "date1=$(date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "date2=$(date "+%Y%m%d%H%M%S")" >> $GITHUB_ENV
          DEVICE="$(awk -F '[="]+' '/TARGET_BOARD/{print $2}' .config)"
          SUBTARGET="$(awk -F '[="]+' '/TARGET_SUBTARGET/{print $2}' .config)"
          if [ "${DEVICE}" == "x86" ]; then
           echo "NAME1=x86-${SUBTARGET}" >> $GITHUB_ENV
          elif [[ ${{matrix.target}} =~ (Lede_phicomm_n1|Project_phicomm_n1) ]]; then
           echo "NAME1=N1,Vplus,Beikeyun,L1Pro,S9xxx" >> $GITHUB_ENV
          else
           grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > NAME1
           [ -s NAME1 ] && echo "NAME1=$(cat NAME1)" >> $GITHUB_ENV
          fi

      - name: ä¸Šä¼ binæ–‡ä»¶å¤¹(å›ºä»¶+ipk)åœ¨github actions
        uses: actions/upload-artifact@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin_${{ env.NAME2 }}_${{ env.NAME1 }}_${{ env.date }}
          path: openwrt/bin

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        id: organizer
        run: |
          cd openwrt
          if [[ "${REGULAR_UPDATE}" == "true" ]]; then
            source "${PATH1}/upgrade.sh" && Diy_Part3
          fi
          if [ -n "$(ls -A "bin/targets/x86" 2>/dev/null)" ]; then
            find bin/targets/x86/* -name "*kernel*" | xargs -i mv -f {} bin/targets
          fi
          cd bin/targets/*/*
          rm -rf packages && mkdir packages
          find -name "*feeds.buildinfo*" | xargs -i mv -f {} packages
          find -name "*version.buildinfo*" | xargs -i mv -f {} packages
          find -name "*sha256sums*" | xargs -i mv -f {} packages
          find -name "*manifest*" | xargs -i mv -f {} packages
          find -name "*vmlinuz*" | xargs -i mv -f {} packages
          find -name "*Image*" | xargs -i mv -f {} packages
          find -name "*.vmdk*" | xargs -i mv -f {} packages
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "BOT=TRUE" >> $GITHUB_ENV
          echo "::set-output name=status::success"

      - name: ä¸Šä¼ å›ºä»¶åœ¨github actions
        uses: actions/upload-artifact@v2
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        with:
          name: OpenWrt-${{ env.NAME2 }}-${{ env.NAME1 }}-firmware-${{ env.date }}
          path: ${{ env.FIRMWARE }}

      - name: æŠŠå®šæ—¶æ›´æ–°å›ºä»¶å‘å¸ƒåˆ°äº‘ç«¯
        uses: softprops/action-gh-release@v1
        if: steps.organizer.outputs.status == 'success' && env.REGULAR_UPDATE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          name: å®šæ—¶å‡çº§äº‘ç«¯åœ°å€
          tag_name: update_Firmware
          files: ${{ env.artifact }}/*

      - name: æ•´ç†å‘å¸ƒä¿¡æ¯
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        run: |
          echo "â˜†  å‘å¸ƒäº$(date +"%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")(#${{github.run_number}})" > update_log.txt
          echo "â˜†  æºç  : ${{ env.REPO_URL }}" >> update_log.txt
          echo "â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}" >> update_log.txt
          echo "â˜†  æ„Ÿè°¢æºç ä½œè€…[ ${{ env.ZUOZHE }}å¤§ç¥ ]æ— ç§åˆ†äº«ï¼" >> update_log.txt

      - name: å‘å¸ƒå›ºä»¶
        uses: ncipollo/release-action@v1
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        with:
          name: ${{ env.date1 }} ã€Œ ${{ env.NAME2 }}-${{ env.NAME1 }} ã€å›ºä»¶
          tag: ${{ env.date2 }}
          token: ${{ secrets.REPO_TOKEN }}
          body: |
            â˜†  å‘å¸ƒäº${{env.date1}}
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…[ ${{ env.ZUOZHE }}å¤§ç¥ ]æ— ç§åˆ†äº«ï¼"
          artifacts: "${{ env.FIRMWARE }}/*"

      - name: ç”µæŠ¥æœºå™¨äººä¿¡æ¯é€šçŸ¥
        run: |
          curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨æ‚¨è¦ç¼–è¯‘çš„[ ${{ env.NAME2 }}-${{ env.NAME1 }} ]å›ºä»¶é¡ºåˆ©ç¼–è¯‘å®Œæˆäº†ï¼

            å®Œæˆæ—¶é—´ï¼š${{ env.date1 }}

            å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}/releases

            ç¥å°ä¸»äººè§äººçˆ±ï¼ŒğŸ’èŠ±è§èŠ±å¼€ï¼Œè½¦è§è½¦è½½ï¼Œå¤©å¤©å¥½å¿ƒæƒ…ğŸˆï¼ï¼ï¼" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
