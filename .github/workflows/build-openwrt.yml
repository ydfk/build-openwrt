#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
#
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#
name: ç¼–è¯‘OpenWrtå›ºä»¶
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSHè¿œç¨‹"
        required: false
        default: "ssh-actions"

  #å®šæ—¶è§¦å‘å¼€å§‹ç¼–è¯‘(æŠŠä¸‹é¢ä¸¤ä¸ª#å»æ‰å¼€å¯,æ—¶é—´è®¾ç½®è¯·çœ‹å®šæ—¶ç¼–è¯‘è¯´æ˜)
  # schedule:
  #   - cron: 0 18 * * SAT

env:
  GITURL: https://github.com/${{github.repository}}
  Author: ${{github.actor}}
  Apidz: ${{github.repository}}
  Run_number: ${{github.run_number}}
  Run_workflow: ${{github.workflow}}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ "${{matrix.target}}"
    strategy:
      fail-fast: false
      matrix:
        target: [Lede_x86_64]

    steps:
      - name: å‡†å¤‡ç»“æŸ
        uses: actions/checkout@v2

      - name: æ£€æµ‹è„šæœ¬è®¾ç½®
        run: |
          source "${GITHUB_WORKSPACE}/build/${{matrix.target}}/settings.ini"
          echo "Modelfile=${{matrix.target}}" >> $GITHUB_ENV
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
          echo "DIY_PART_SH=${DIY_PART_SH}" >> $GITHUB_ENV
          echo "SSH_ACTIONS=${SSH_ACTIONS}" >> $GITHUB_ENV
          echo "UPLOAD_BIN_DIR=${UPLOAD_BIN_DIR}" >> $GITHUB_ENV
          echo "UPLOAD_CONFIG=${UPLOAD_CONFIG}" >> $GITHUB_ENV
          echo "UPLOAD_FIRMWARE=${UPLOAD_FIRMWARE}" >> $GITHUB_ENV
          echo "UPLOAD_COWTRANSFER=${UPLOAD_COWTRANSFER}" >> $GITHUB_ENV
          echo "UPLOAD_RELEASE=${UPLOAD_RELEASE}" >> $GITHUB_ENV
          echo "SERVERCHAN_SCKEY=${SERVERCHAN_SCKEY}" >> $GITHUB_ENV
          echo "REGULAR_UPDATE=${REGULAR_UPDATE}" >> $GITHUB_ENV
          echo "CangKu=${Apidz##*/}" >> $GITHUB_ENV
          echo "Updete_firmware=${Updete_firmware}" >> $GITHUB_ENV
          echo "Extension=${Extension}" >> $GITHUB_ENV
          echo "GITHUB_RELEASE=$(grep "https://github.com/[a-zA-Z0-9]" ${GITHUB_WORKSPACE}/.git/config | cut -c8-100)" >> $GITHUB_ENV
          echo "BY_INFORMATION=${BY_INFORMATION}" >> $GITHUB_ENV

      - name: å…¬ å‘Š
        run: |
          echo
          chmod -R +x "${GITHUB_WORKSPACE}/build/common"
          echo "Compile_Date=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
          if [[ "${REPO_BRANCH}" == "master" ]]; then
            echo "ZZZ=package/lean/default-settings/files/zzz-default-settings" >> $GITHUB_ENV
            echo "CODE=Lede" >> $GITHUB_ENV
            echo "OpenWrt_name=18.06" >> $GITHUB_ENV
          elif [[ "${REPO_BRANCH}" == "19.07" ]]; then
            echo "ZZZ=package/default-settings/files/zzz-default-settings" >> $GITHUB_ENV
            echo "CODE=Lienol" >> $GITHUB_ENV
            echo "OpenWrt_name=19.07" >> $GITHUB_ENV
          fi
          source build/common/common.sh && Diy_gonggao
          source build/common/common.sh && Diy_tongzhi

      - name: ç”µæŠ¥æœºå™¨äººä¿¡æ¯é€šçŸ¥
        if: env.SERVERCHAN_SCKEY == 'true'
        run: |
          curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=ğŸ‰ ä¸»äººï¼šæ‚¨æ­£åœ¨ä½¿ç”¨ã€${{matrix.target}}ã€‘æ–‡ä»¶å¤¹ç¼–è¯‘å›ºä»¶ä¸­(${{env.CangKu}}ä»“åº“çš„#${{env.Run_number}}å·),è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"

      - name: æ•´ç†ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q` > /dev/null 2>&1
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /usr/lib/jvm /opt/ghc
          sudo -E apt-get -qq update
          sudo apt-get full-upgrade -y
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ä¸‹è½½"${{matrix.target}}"æºç 
        working-directory: /workdir
        run: |
          git clone -b "$REPO_BRANCH" --single-branch "$REPO_URL" openwrt
          cd openwrt
          ./scripts/feeds clean && ./scripts/feeds update -a > /dev/null 2>&1
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "Home=${GITHUB_WORKSPACE}/openwrt" >> $GITHUB_ENV
          echo "PATH1=${GITHUB_WORKSPACE}/openwrt/build/${{matrix.target}}" >> $GITHUB_ENV
          echo "artifact=${GITHUB_WORKSPACE}/openwrt/bin/Firmware" >> $GITHUB_ENV

      - name: åŠ è½½æº,patchè¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
        run: |
          cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
          mv -f "${Home}"/build/common/Convert.sh "${Home}"
          mv -f "${Home}"/build/common/*.sh "${PATH1}"
          source "${PATH1}/common.sh" && Diy_settings
          if [[ "${{ github.event.inputs.ssh }}" == 'ssh' ]]; then
            echo "SSHYC=true" >> $GITHUB_ENV
          fi
          cd openwrt
          if [[ "${REPO_BRANCH}" == "master" ]]; then
            source "${PATH1}/common.sh" && Diy_lede
            cp -Rf "${Home}"/build/common/LEDE/files "${Home}"
            cp -Rf "${Home}"/build/common/LEDE/diy/* "${Home}"
            cp -Rf "${Home}"/build/common/LEDE/patches/* "${PATH1}/patches"
          elif [[ "${REPO_BRANCH}" == "19.07" ]]; then
            source "${PATH1}/common.sh" && Diy_lienol
            cp -Rf "${Home}"/build/common/LIENOL/files "${Home}"
            cp -Rf "${Home}"/build/common/LIENOL/diy/* "${Home}"
            cp -Rf "${Home}"/build/common/LIENOL/patches/* "${PATH1}/patches"
          fi
          source "${PATH1}/common.sh" && Diy_all
          /bin/bash "${PATH1}/$DIY_PART_SH"
          if [ -n "$(ls -A "${PATH1}/diy" 2>/dev/null)" ]; then
            cp -Rf "${PATH1}"/diy/* "${Home}"
          fi
          if [ -n "$(ls -A "${PATH1}/files" 2>/dev/null)" ]; then
            cp -Rf "${PATH1}/files" "${Home}" && chmod -R +x ${Home}/files
          fi
          if [ -n "$(ls -A "${PATH1}/patches" 2>/dev/null)" ]; then
            find "${PATH1}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p1 --forward --no-backup-if-mismatch"
          fi
          ./scripts/feeds update -a && ./scripts/feeds install -a
          [ -e "$PATH1/$CONFIG_FILE" ] && mv "$PATH1/$CONFIG_FILE" .config
          if [[ "${REGULAR_UPDATE}" == "true" ]]; then
            source "${PATH1}/upgrade.sh" && Diy_Part1
          fi

      - name: SSHè¿œç¨‹è¿æ¥
        uses: P3TERX/ssh2actions@v1.0.0
        if: env.SSH_ACTIONS == 'true' || (github.event.inputs.ssh == 'ssh' && github.event.inputs.ssh  != 'false')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          cd openwrt
          source "${PATH1}/common.sh" && Diy_chajian > /dev/null 2>&1
          make defconfig > /dev/null 2>&1
          echo "TARGET_BOARD=$(awk -F '[="]+' '/TARGET_BOARD/{print $2}' .config)" >> $GITHUB_ENV
          echo "TARGET_SUBTARGET=$(awk -F '[="]+' '/TARGET_SUBTARGET/{print $2}' .config)" >> $GITHUB_ENV
          if [ `grep -c "CONFIG_TARGET_x86_64=y" .config` -eq '1' ]; then
            echo "x86-64" > DEVICE_NAME
            [ -s DEVICE_NAME ] && echo "TARGET_PROFILE=$(cat DEVICE_NAME)" >> $GITHUB_ENV
          elif [ `grep -c "CONFIG_TARGET.*DEVICE.*=y" .config` -eq '1' ]; then
            grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
            [ -s DEVICE_NAME ] && echo "TARGET_PROFILE=$(cat DEVICE_NAME)" >> $GITHUB_ENV
          else
            echo "TARGET_PROFILE=armvirt" >> $GITHUB_ENV
          fi

      - name: ç¼–è¯‘ä¿¡æ¯
        run: |
          cd openwrt
          source "${PATH1}/common.sh" && Diy_chuli > /dev/null 2>&1
          if [ "${REGULAR_UPDATE}" == "true" ]; then
            source "${PATH1}/upgrade.sh" && Diy_Part2 > /dev/null 2>&1
          fi
          if [ "${BY_INFORMATION}" == "true" ]; then
            source "${PATH1}/upgrade.sh" > /dev/null 2>&1
            source "${PATH1}/common.sh" && Diy_xinxi
          fi

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          make -j$(nproc) V=s
          echo "::set-output name=status::success"
          echo "date=$(date "+%Y%m%d%H%M%S")" >> $GITHUB_ENV
          echo "date1=$(date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "date2=$(date "+%Y%m%d%H%M%S")" >> $GITHUB_ENV

      - name: ä¸Šä¼ binæ–‡ä»¶å¤¹(å›ºä»¶+ipk)åœ¨github actions
        uses: actions/upload-artifact@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin_${{ env.Code }}_${{ env.TARGET_PROFILE }}_${{ env.date }}
          path: openwrt/bin

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        id: organizer
        run: |
          cd openwrt
          if [[ "${REGULAR_UPDATE}" == "true" ]]; then
            source "${PATH1}/upgrade.sh" && Diy_Part3
          fi
          if [ -n "$(ls -A "bin/targets/x86" 2>/dev/null)" ]; then
            find bin/targets/x86/* -name "*kernel*" | xargs -i mv -f {} bin/targets
          fi
          cd bin/targets/*/*
          rm -rf packages && mkdir packages
          find -name "*feeds.buildinfo*" | xargs -i mv -f {} packages
          find -name "*version.buildinfo*" | xargs -i mv -f {} packages
          find -name "*sha256sums*" | xargs -i mv -f {} packages
          find -name "*manifest*" | xargs -i mv -f {} packages
          find -name "*vmlinuz*" | xargs -i mv -f {} packages
          find -name "*Image*" | xargs -i mv -f {} packages
          find -name "*.vmdk*" | xargs -i mv -f {} packages
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "BOT=TRUE" >> $GITHUB_ENV
          echo "::set-output name=status::success"

      # - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶åœ¨github actions
      #   uses: actions/upload-artifact@v2
      #   if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true'
      #   with:
      #     name: .config_${{ env.CODE }}_${{ env.TARGET_PROFILE }}_${{ env.date }}
      #     path: openwrt/bin/config

      - name: ä¸Šä¼ å›ºä»¶åœ¨github actions
        uses: actions/upload-artifact@v2
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        with:
          name: OpenWrt-${{ env.Code }}-${{ env.TARGET_PROFILE }}-firmware-${{ env.date }}
          path: ${{ env.FIRMWARE }}

      - name: æŠŠå®šæ—¶æ›´æ–°å›ºä»¶å‘å¸ƒåˆ°äº‘ç«¯
        uses: softprops/action-gh-release@v1
        if: steps.organizer.outputs.status == 'success' && env.REGULAR_UPDATE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          name: å®šæ—¶å‡çº§äº‘ç«¯åœ°å€
          tag_name: update_Firmware
          files: ${{ env.artifact }}/*

      - name: æ•´ç†å‘å¸ƒä¿¡æ¯
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        run: |
          echo "â˜†  å‘å¸ƒäº$(date +"%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")(#${{github.run_number}})" > update_log.txt
          echo "â˜†  æºç  : ${{ env.REPO_URL }}" >> update_log.txt
          echo "â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}" >> update_log.txt

      - name: å‘å¸ƒå›ºä»¶
        uses: ncipollo/release-action@v1
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        with:
          name: ${{ env.date1 }} ã€Œ ${{ env.Code }}-${{ env.TARGET_PROFILE }} ã€å›ºä»¶
          tag: ${{ env.date2 }}
          token: ${{ secrets.REPO_TOKEN }}
          body: |
            â˜†  å‘å¸ƒäº${{env.date1}}
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
          artifacts: "${{ env.FIRMWARE }}/*"

      - name: ç”µæŠ¥æœºå™¨äººä¿¡æ¯é€šçŸ¥
        if: env.SERVERCHAN_SCKEY == 'true'
        run: |
          curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨æ‚¨è¦ç¼–è¯‘çš„[ ${{ env.Code }}-${{ env.TARGET_PROFILE }} ]å›ºä»¶é¡ºåˆ©ç¼–è¯‘å®Œæˆäº†ï¼
            å®Œæˆæ—¶é—´ï¼š${{ env.date1 }}
            å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}/releases
            å›ºä»¶: ${{ env.CangKu }}ä»“åº“çš„#${{ env.Run_number }}å·
            ç¥å°ä¸»äººè§äººçˆ±ï¼ŒğŸ’èŠ±è§èŠ±å¼€ï¼Œè½¦è§è½¦è½½ï¼Œå¤©å¤©å¥½å¿ƒæƒ…ğŸˆï¼ï¼ï¼" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
